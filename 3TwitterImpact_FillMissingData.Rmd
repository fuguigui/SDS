---
title: "R Notebook"
author: "Haojun Cai"
date: "17/4/2020"
output: html_notebook
---

# For language "it"
The speciality of language 'it' is that, on date 0403 the data is not complete. One unexpected error about 'user_id' sometimes occurs. Thus, missing values need to be handled. That is why the counts per hour is calculated and returned for now as the variable 'impactbyhour'.

```{r function}
calImpactIt <- function(it,init_dates){
  # Load data catched once
  for (date in init_dates){
    dname = paste(it,date,sep="")
    fname = paste("./data/",it,"/Tweet",date,it,".RData",sep="")
    load(fname)
    assign(dname,tweets)
  }
    
  # Return the last catched time
  last_createdtime = c()
  
  for (date in init_dates){
    dname = eval(as.symbol(paste(it,date,sep="")))
    dname <- dname[order(dname$created_at),]
    last_createdtime <- append(last_createdtime,dname$created_at[1])
  }

  # Extract hour information
  require(lubridate)
  require(dplyr)
  
  impactbyhour <- data.frame(init_dates)
  for (i in 00:23){
    impactbyhour[toString(i)] <- NA  
  }
  
  # Get the statistics per hour
  for (date in init_dates){
    dname = eval(as.symbol(paste(it,date,sep="")))
    dname["created_at_hour"] = hour(dname$created_at)
    dname %>% count(created_at_hour) -> stat_hour
    for (i in 1:nrow(stat_hour)){
      hour = stat_hour$created_at_hour[i]
      rowidx = which(impactbyhour==date)
      impactbyhour[rowidx,toString(hour)] = stat_hour$n[i]
    }
  }
  
  print(paste("Finish impact calculation for",it,"by hour"))
  return(list("impactbyhour"=impactbyhour,"last_createdtime"=last_createdtime))
}
```

# Set the working directory
Remeber to change the working directory.

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = "E:\\5_Social Data Science\\old_keyword")
```

# Demo 2
To test on other datasets, change the variable 'init_dates'. Besides, packages 'lubridate' and 'dplyr' are required to install for this function.

```{r}
it = c("it")
init_dates = paste("0",c(311:331,401:415),sep="")
values <- calImpactIt(it,init_dates)
impactbyhour <- values$impactbyhour
last_createdtime <- values$last_createdtime
```

# Handle missing data in time series
# Bad for Kalman since there are only three known values on that missing date
```{r}
library(imputeTS)
# Impute the missing values with na_kalman
missval = as.numeric(t(impactbyhour[which(init_dates=="0403"),]))
completeval = as.numeric(t(impactbyhour[which(init_dates=="0405"),]))
imp <- na_kalman(missval)
#Code for visualization
plotNA.imputations(missval, imp, completeval)
```

```{r}
missval = as.numeric(t(impactbyhour[which(init_dates=="0403"),]))
completeval1 = as.numeric(t(impactbyhour[which(init_dates=="0402"),]))
completeval2 = as.numeric(t(impactbyhour[which(init_dates=="0404"),]))
completeval3 = as.numeric(t(impactbyhour[which(init_dates=="0401"),]))
completeval4 = as.numeric(t(impactbyhour[which(init_dates=="0405"),]))
plot(missval,type="l",col="red")
lines(completeval1,col="green")
lines(completeval2,col="green")
lines(completeval3,col="blue")
lines(completeval4,col="blue")
```
It seems the data on date '0403' is an outlier according to the above figure.
